/*! colocation_dashboard_js 2020-05-17 */

function onlyUnique(t,e,a){return a.indexOf(t)===e}addDropdownElement=function(t,e,a,n){d3.select("#"+n).append("option").attr("value",t).text(e).attr("class",a)},refreshPanel=function(){d3.select("#panel-c").remove(),d3.select(".main").append("div").attr("class","main-container").attr("id","panel-c")},d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},styleArea=function(t,e){for(i in area_polygons=d3.selectAll(".country")._groups[0],area_polygons)area_polygons[i].getAttribute("polygon-name")==t&&area_polygons[i].setAttribute("class",e)},unstyleArea=function(t){selected_area=d3.selectAll("."+t),country=selected_area.attr("country-name"),selected_area.attr("class","country "+country)},d3.select("#map-c").append("svg").attr("class","main-map").attr("id","main-m"),d3.select("#map-c").append("div").attr("class","dropdown-container"),d3.select("#dropdown-c").append("select").attr("class","area-dropdown").attr("id","area-d"),$(document).ready(function(){$(".area-dropdown").select2()}),$("select").on("change",function(){area_name=this.value,ts_plot1.removePlotContent(),ts_plot1.addPlotContent(area_name),ts_plot2.addPlotContent(area_name),d3.select("#area-title-c").text(area_name),ac_panel1.removePlotContent(area_name),ac_panel1.addPlotContent(area_name)}),geodata_url="https://raw.githubusercontent.com/hamishgibbs/colocation_dashboard/master/geodata/UK_simple.geojson?token=AMBPN73QL5NPJQGMNVT3YYS6ZEXXA",map_svg=d3.select("#main-m"),map_svg_dims=document.getElementById("main-m").getBoundingClientRect();var projection=d3.geoMercator().translate([map_svg_dims.width/2,map_svg_dims.height/2]).scale(2200).center([-4.5,55]);console.log(5.5*map_svg_dims.width);var path=d3.geoPath().projection(projection);Promise.all([d3.json(geodata_url)]).then(function(t){t=t[0],country_class=t.features.map(function(t){return"country "+t.properties.NAME_1}),map_svg.append("g").attr("class","areas").selectAll("path").data(t.features).enter().append("path").attr("d",path).attr("fill","lightgray").attr("stroke","white").attr("class",mapCountryClass).attr("polygon-name",function(t){return t.properties.NAME_2}).attr("country-name",function(t){return t.properties.NAME_1}).on("click",mainMapClick).on("mousein",d3.selection.prototype.moveToFront)}),sizeChange=function(){d3.select(".areas").attr("transform","scale("+$("#map-c").width()/700+")"),$(".areas").height(.618*$("#map-c").width())},d3.select(window).on("resize",sizeChange),mapCountryClass=function(t){return ts_plot1.area_names.includes(t.properties.NAME_2)?"country "+t.properties.NAME_1:"country no-data"},mainMapClick=function(){area_name=d3.select(this).attr("polygon-name"),ts_plot1.removePlotContent(),ts_plot1.addPlotContent(area_name),ts_plot2.addPlotContent(area_name),d3.select("#area-title-c").text(area_name),ac_panel1.removePlotContent(area_name),ac_panel1.addPlotContent(area_name)},ac_panel=function(){this.data_url="https://raw.githubusercontent.com/hamishgibbs/colocation_dashboard/master/UK/data/top_n_between.csv?token=AMBPN7Z5M4FWWPHZJ5T2KLC6ZEX54",this.data=null,this.default_area="Greater London",this.margin={top:10,right:50,bottom:0,left:40},this.containerDims=d3.select("#panel-c").node().getBoundingClientRect(),this.width=this.containerDims.width-this.margin.left-this.margin.right,this.height=this.containerDims.height-this.margin.top-this.margin.bottom,this.setupAcPanel=function(){this.svg=d3.select("#panel-c").append("svg").attr("class","ac-plot").append("g").attr("class","ac-plot-content"),this.sankey=d3.sankey().nodeWidth(30).nodePadding(50).size([this.width,this.height]),this.path=this.sankey.link()},this.addPlotContent=function(e){try{unstyleArea("area-active")}catch(t){console.log(t)}plot_data=this.data.filter(function(t){return t.polygon1_name==e}),console.log(plot_data),graph={nodes:[],links:[]},plot_data.forEach(function(t){graph.nodes.push({name:t.polygon1_name}),graph.nodes.push({name:t.polygon2_name}),graph.links.push({source:t.polygon1_name,target:t.polygon2_name,value:+t.mean_colocation})}),console.log(graph),graph.nodes=d3.keys(d3.nest().key(function(t){return t.name}).object(graph.nodes)),graph.links.forEach(function(t,e){graph.links[e].source=graph.nodes.indexOf(graph.links[e].source),graph.links[e].target=graph.nodes.indexOf(graph.links[e].target)}),graph.nodes.forEach(function(t,e){graph.nodes[e]={name:t}}),this.sankey.nodes(graph.nodes).links(graph.links).layout(32);var t=this.svg.append("g").selectAll(".link").data(graph.links).enter().append("path").attr("class","link").attr("d",this.path).attr("stroke-opacity",.1).attr("value",function(t){return t.target.name}).attr("area-name",function(t){return t.target.name}).style("stroke-width",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy}).on("mouseover",this.linkMouseOver).on("mouseout",this.linkMouseOut).on("click",this.sankeyClick);t.transition().duration(400).ease(d3.easeLinear).style("stroke-opacity",.25).attr("stroke-dashoffset",0),t.append("title").text(function(t){return t.source.name+" â†’ "+t.target.name+"\n"+t.value});var a=this.svg.append("g").selectAll(".node").data(graph.nodes).enter().append("g").attr("class","node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"});a.append("rect").attr("height",function(t){return t.dy}).attr("width",this.sankey.nodeWidth()).attr("area-name",function(t){return t.name}).style("fill","lightgrey").on("click",this.sankeyClick).append("title").text(function(t){return t.name+"\n"+t.value}),a.append("text").attr("x",function(t){return t.name==e?36:-6}).attr("y",function(t){return t.dy/2}).attr("dy",".35em").attr("text-anchor",function(t){return t.name==e?"beginning":"end"}).attr("transform",null).text(function(t){return t.name+" "+parseFloat(t.value.toFixed(7)).toExponential()}).filter(function(t){return t.x<this.width/2}).attr("x",6+this.sankey.nodeWidth()).attr("text-anchor","start"),styleArea(e,"area-active")},this.removePlotContent=function(){d3.selectAll(".ac-plot-content").remove(),this.svg=d3.selectAll(".ac-plot").append("g").attr("class","ac-plot-content")},this.linkMouseOver=function(){hovered_area=d3.select(this).attr("value"),styleArea(hovered_area,"area-selected")},this.linkMouseOut=function(){unstyleArea("area-selected")},this.sankeyClick=function(){}},ac_panel1=new ac_panel,ac_panel1.sankeyClick=function(){console.log(this),area_name=d3.select(this).attr("area-name"),unstyleArea("area-selected"),ac_panel1.removePlotContent(area_name),ac_panel1.addPlotContent(area_name)},d3.csv(ac_panel1.data_url,d3.autoType).then(function(t){ac_panel1.data=t}),d3.sankey=function(){var e={},n=24,i=8,l=[1,1],s=[],r=[];function a(){function e(t,e){return t.source.y-e.source.y}function a(t,e){return t.target.y-e.target.y}s.forEach(function(t){t.sourceLinks.sort(a),t.targetLinks.sort(e)}),s.forEach(function(t){var e=0,a=0;t.sourceLinks.forEach(function(t){t.sy=e,e+=t.dy}),t.targetLinks.forEach(function(t){t.ty=a,a+=t.dy})})}function c(t){return t.y+t.dy/2}function d(t){return t.value}return e.nodeWidth=function(t){return arguments.length?(n=+t,e):n},e.nodePadding=function(t){return arguments.length?(i=+t,e):i},e.nodes=function(t){return arguments.length?(s=t,e):s},e.links=function(t){return arguments.length?(r=t,e):r},e.size=function(t){return arguments.length?(l=t,e):l},e.layout=function(t){return s.forEach(function(t){t.sourceLinks=[],t.targetLinks=[]}),r.forEach(function(t){var e=t.source,a=t.target;"number"==typeof e&&(e=t.source=s[t.source]),"number"==typeof a&&(a=t.target=s[t.target]),e.sourceLinks.push(t),a.targetLinks.push(t)}),s.forEach(function(t){t.value=Math.max(d3.sum(t.sourceLinks,d),d3.sum(t.targetLinks,d))}),function(){var e,t=s,a=0;for(;t.length;)e=[],t.forEach(function(t){t.x=a,t.dx=n,t.sourceLinks.forEach(function(t){e.indexOf(t.target)<0&&e.push(t.target)})}),t=e,++a;(function(e){s.forEach(function(t){t.sourceLinks.length||(t.x=e-1)})})(a),function(e){s.forEach(function(t){t.x*=e})}((l[0]-n)/(a-1))}(),function(t){var e=d3.nest().key(function(t){return t.x}).sortKeys(d3.ascending).entries(s).map(function(t){return t.values});(function(){var a=d3.min(e,function(t){return(l[1]-(t.length-1)*i)/d3.sum(t,d)});e.forEach(function(t){t.forEach(function(t,e){t.y=e,t.dy=t.value*a})}),r.forEach(function(t){t.dy=t.value*a})})(),n();for(var a=1;0<t;--t)!function(a){function n(t){return c(t.target)*t.value}e.slice().reverse().forEach(function(t){t.forEach(function(t){var e;t.sourceLinks.length&&(e=d3.sum(t.sourceLinks,n)/d3.sum(t.sourceLinks,d),t.y+=(e-c(t))*a)})})}(a*=.99),n(),function(a){function n(t){return c(t.source)*t.value}e.forEach(function(t,e){t.forEach(function(t){var e;t.targetLinks.length&&(e=d3.sum(t.targetLinks,n)/d3.sum(t.targetLinks,d),t.y+=(e-c(t))*a)})})}(a),n();function n(){e.forEach(function(t){var e,a,n,s=0,r=t.length;for(t.sort(o),n=0;n<r;++n)0<(a=s-(e=t[n]).y)&&(e.y+=a),s=e.y+e.dy+i;if(0<(a=s-i-l[1]))for(s=e.y-=a,n=r-2;0<=n;--n)0<(a=(e=t[n]).y+e.dy+i-s)&&(e.y-=a),s=e.y})}function o(t,e){return t.y-e.y}}(t),a(),e},e.relayout=function(){return a(),e},e.link=function(){var l=.5;function e(t){var e=t.source.x+t.source.dx,a=t.target.x,n=d3.interpolateNumber(e,a),s=n(l),r=n(1-l),o=t.source.y+t.sy+t.dy/2,i=t.target.y+t.ty+t.dy/2;return"M"+e+","+o+"C"+s+","+o+" "+r+","+i+" "+a+","+i}return e.curvature=function(t){return arguments.length?(l=+t,e):l},e},e},ov_panel=function(){this.image_url="https://raw.githubusercontent.com/hamishgibbs/colocation_dashboard/master/UK/images/colocation_plot.png?token=AMBPN77JGGJC7WCEQJFNAGS6ZJOBW",this.image_svg_url="https://raw.githubusercontent.com/hamishgibbs/colocation_dashboard/master/UK/images/colocation_plot.svg?token=AMBPN72Q3JPY4GHSSRTLM226YDTVE",this.setupOvPanel=function(){this.container=d3.select("#panel-c").append("div").attr("class","ov-container"),containerDims=this.container.node().getBoundingClientRect(),this.container.append("div").attr("class","area-title-container").text("Facebook Colocation Data"),this.container.append("img").attr("src",this.image_url).attr("class","ov-image"),this.container.append("div").attr("class","ov-blurb"),$(".ov-blurb").html(this.blurb_text)},this.blurb_text=null};var blurb_url="https://raw.githubusercontent.com/hamishgibbs/colocation_dashboard/master/UK/text/blurb.html?token=AMBPN76YXBH2X477JHLXUY26ZB364";$.ajax({url:blurb_url,dataType:"text",success:function(t){ov_panel1.blurb_text=t,$(".ov-blurb").html(t)}}),description_panel=function(){this.fb_image_url="https://assets.themuse.com/uploaded/companies/659/small_logo.png?v=e06509d06aae79458f7a2fe65f39bcb4cca56e964dd6d9e0390386ca1829e55a",this.cmmid_image_url="https://www.lshtm.ac.uk/sites/default/files/styles/centre_header_logo/public/cmmid.jpg?itok=DVpjwx1l",this.lshtm_image_url="http://pathogenseq.lshtm.ac.uk/img/lshtm-logo.jpg",this.fb_url="https://dataforgood.fb.com/",this.cmmid_url="https://www.lshtm.ac.uk/research/centres/centre-mathematical-modelling-infectious-diseases",this.lshtm_url="https://www.lshtm.ac.uk/",this.description_text=null,this.setupDdPanel=function(){this.container=d3.select("#panel-c").append("div").attr("class","area-title-container").attr("id","description-tt").text("Dataset Description"),this.container.append("div").attr("class","description-text").attr("id","description-t"),this.credits_panel=this.container.append("div").attr("class","credits-container").attr("id","credits-panel"),this.credits_panel.append("div").attr("class","image-container").append("a").attr("href",this.fb_url).attr("target","_blank").append("img").attr("src",this.fb_image_url).attr("class","credit-image"),this.credits_panel.append("div").attr("class","image-container").append("a").attr("href",this.lshtm_url).attr("target","_blank").append("img").attr("src",this.lshtm_image_url).attr("class","credit-image"),this.credits_panel.append("div").attr("class","image-container").append("a").attr("href",this.cmmid_url).attr("target","_blank").append("img").attr("src",this.cmmid_image_url).attr("class","credit-image"),this.container.append("div").attr("class","author-container").attr("id","author-panel").text("Visualisation by Hamish Gibbs. Supported by CMMID Covid-19 Working Group, Rosalind M Eggo, Chris Grundy, and Adam Kucharski."),$(".description-text").html(this.description_text)}};var description_url="https://raw.githubusercontent.com/hamishgibbs/colocation_dashboard/master/UK/text/description.html?token=AMBPN75TSPROKJZZP4WJPDS6ZB4EQ";$.ajax({url:description_url,dataType:"text",success:function(t){description_panel1.description_text=t,$(".description-text").html(t)}}),tsButtonClick=function(){d3.selectAll(".panel-button").attr("id",null),d3.select(this).attr("id","active-button"),refreshPanel(),d3.select("#panel-c").append("div").attr("class","area-title-container").attr("id","area-title-c"),ts_plot1.appendSVG("panel-c","ts1-c","ts-container","ts1","ts-plot"),ts_plot2.appendSVG("panel-c","ts2-c","ts-container","ts2","ts-plot"),ts_plot1.layoutPlot(),ts_plot2.layoutPlot(),d3.select("#area-title-c").text(ts_plot1.default_area),createTsSummaryButtons("panel-c")},ov_panel1=new ov_panel,ovButtonClick=function(){d3.selectAll(".panel-button").attr("id",null),d3.select(this).attr("id","active-button"),refreshPanel(),ov_panel1.setupOvPanel()},description_panel1=new description_panel,ddButtonClick=function(){d3.selectAll(".panel-button").attr("id",null),d3.select(this).attr("id","active-button"),refreshPanel(),description_panel1.setupDdPanel()},acButtonClick=function(){d3.selectAll(".panel-button").attr("id",null),d3.select(this).attr("id","active-button"),refreshPanel(),ac_panel1.setupAcPanel(),ac_panel1.addPlotContent(ac_panel1.default_area)},d3.select("#panel-select-c").append("div").attr("class","button-spacer"),d3.select("#panel-select-c").append("button").attr("value","ov").text("Overview").attr("class","panel-button").attr("id","active-button").on("click",ovButtonClick),d3.select("#panel-select-c").append("div").attr("class","button-spacer"),d3.select("#panel-select-c").append("button").attr("value","ts").text("Time series").attr("class","panel-button").on("click",tsButtonClick),d3.select("#panel-select-c").append("div").attr("class","button-spacer"),d3.select("#panel-select-c").append("button").attr("value","ac").text("Area Comparison").attr("class","panel-button").on("click",acButtonClick),d3.select("#panel-select-c").append("div").attr("class","button-spacer"),d3.select("#panel-select-c").append("button").attr("value","dd").text("Dataset Description").attr("class","panel-button").on("click",ddButtonClick),$("#active-button").click(),addDropdownElement,ts_data_url="https://raw.githubusercontent.com/hamishgibbs/colocation_dashboard/master/UK/data/mean_ts.csv?token=AMBPN77B6ZW36RRVNPGE2C26ZEX3C";var parseTime=d3.timeParse("%Y-%m-%d");ts_plot=function(){this.data=null,this.area_names=null,this.y_label=null,this.dataset_type=null,this.default_area="Greater London",this.margin={top:0,right:30,bottom:50,left:70},this.printData=function(){console.log(this.data)},this.appendSVG=function(t,e,a,n,s){this.panel=d3.select("#"+t),this.container=d3.select("#"+e),d3.select("#"+t).append("div").attr("id",e).attr("class",a),this.svg=d3.select("#"+e).append("svg").attr("id",n).attr("class",s).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")")},this.defineAxes=function(t,e){console.log(d3.select("#"+t));var a=d3.select("#"+t).node().getBoundingClientRect();this.width=a.width-this.margin.left-this.margin.right,this.height=a.height-this.margin.top-this.margin.bottom,this.x=d3.scaleTime().range([0,this.width]),this.y=d3.scaleLinear().range([this.height,0]),this.x.domain(d3.extent(e,function(t){return t.ds})),this.y.domain([d3.min(e,function(t){return t.mean_colocation}),d3.max(e,function(t){return t.mean_colocation})]);var n=this.x,s=this.y;this.plotLine=d3.line().x(function(t){return n(t.ds)}).y(function(t){return s(t.mean_colocation)})},this.layoutPlot=function(){this.svg.append("g").attr("transform","translate(0,"+this.height+")").call(d3.axisBottom(this.x)),this.svg.append("g").call(d3.axisLeft(this.y)),this.svg.append("text").attr("transform","rotate(-90)").attr("y",0-this.margin.left).attr("x",0-this.height/2).attr("dy","1em").style("text-anchor","middle").text(this.y_label),this.addPlotContent(this.default_area),this.tooltip_div=this.container.append("div").attr("class","tooltip").style("opacity",0)},this.addPlotContent=function(e){if(["England","Wales","Scotland","Northern Ireland"].includes(e))for(i in plot_data=this.data.filter(function(t){return t.NAME_1==e}),area_names=plot_data.map(function(t){return t.polygon1_name}).filter(onlyUnique),area_names)area_data=plot_data.filter(function(t){return t.polygon1_name==area_names[i]}),this.svg.append("path").data([area_data]).attr("class","ts-plot-content summary "+this.dataset_type).attr("d",this.plotLine).attr("value",area_names[i]).on("mouseover",this.changeTitle).on("mouseout",this.resetTitle);else plot_data=this.data.filter(function(t){return t.polygon1_name==e}),this.svg.append("path").data([plot_data]).attr("class","ts-plot-content "+this.dataset_type).attr("d",this.plotLine)},this.changeTitle=function(){var t=d3.select(this).attr("value");d3.select("#area-title-c").text(t),styleArea(t,"area-selected")},this.resetTitle=function(){console.log(d3.select("#summary-button-active").text()),d3.select("#area-title-c").text(d3.select("#summary-button-active").text()),unstyleArea("area-selected")},this.removePlotContent=function(){d3.selectAll(".ts-plot-content").remove()}},createTsSummaryButtons=function(t){d3.select("#"+t).append("div").attr("class","button-spacer"),d3.select("#"+t).append("button").attr("value","England").text("England").attr("class","summary-button").on("click",summaryButtonClick),d3.select("#"+t).append("div").attr("class","button-spacer"),d3.select("#"+t).append("button").attr("value","Wales").text("Wales").attr("class","summary-button").on("click",summaryButtonClick),d3.select("#"+t).append("div").attr("class","button-spacer"),d3.select("#"+t).append("button").attr("value","Scotland").text("Scotland").attr("class","summary-button").on("click",summaryButtonClick),d3.select("#"+t).append("div").attr("class","button-spacer"),d3.select("#"+t).append("button").attr("value","Northern Ireland").text("Northern Ireland").attr("class","summary-button").on("click",summaryButtonClick)},summaryButtonClick=function(){d3.selectAll(".summary-button").attr("id",null),d3.select(this).attr("id","summary-button-active"),ts_plot1.removePlotContent(),ts_plot2.removePlotContent(),ts_plot1.addPlotContent(this.value),ts_plot2.addPlotContent(this.value),d3.select("#area-title-c").text(this.value)};var ts_plot1=new ts_plot;ts_plot1.y_label="% change of colocation probabilty outside home area",ts_plot1.appendSVG("panel-c","ts1-c","ts-container","ts1","ts-plot");var ts_plot2=new ts_plot;ts_plot2.y_label="Probabilty of colocation outside home area",ts_plot2.appendSVG("panel-c","ts2-c","ts-container","ts2","ts-plot"),ts_plot1.dataset_type="between",ts_plot2.dataset_type="within",Promise.all([d3.csv(ts_data_url,d3.autoType)]).then(function(t){for(i in t=t[0],area_names=t.map(function(t){return t.polygon1_name}).filter(onlyUnique),ts_plot1.area_names=area_names,area_names)addDropdownElement(area_names[i],area_names[i],"dropdown-element","area-d");perc_data=t.filter(function(t){return"perc_change"==t.type}),perc_data=perc_data.filter(function(t){return t.mean_colocation<=200}),abs_data=t.filter(function(t){return"abs_value"==t.type}),ts_plot1.data=perc_data,ts_plot2.data=abs_data,ts_plot1.defineAxes("ts1-c",perc_data),ts_plot2.defineAxes("ts2-c",abs_data),d3.select("#area-title-c").text(ts_plot1.default_area)});